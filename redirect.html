<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Redirecting...</title>

<!-- Код Яндекс.Метрики -->
<script type="text/javascript">
(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
m[i].l=1*new Date();
k=e.createElement(t),a=e.getElementsByTagName(t)[0],
k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

ym(105090249, "init", {
     clickmap:true,
     trackLinks:true,
     accurateTrackBounce:true
});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/105090249" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Метрика -->

</head>
<body>
<script>
function waitForYm(callback, interval = 50, timeout = 3000) {
  const start = Date.now();
  (function check() {
    if (typeof ym !== "undefined") {
      callback();
    } else if (Date.now() - start < timeout) {
      setTimeout(check, interval);
    } else {
      console.warn("⚠️ ym not found, continuing redirect");
      callback(); // редирект всё равно
    }
  })();
}

waitForYm(() => {
  const params = new URLSearchParams(location.search);
  const target = params.get("target");
  if (!target) { 
    document.body.innerHTML = "<h2>Missing target parameter</h2>";
    console.log("❌ no target"); 
    return; 
  }

  // Сохраняем все параметры кроме target
  const extra = [];
  params.forEach((v,k)=>{ if(k!=="target") extra.push(`${encodeURIComponent(k)}=${encodeURIComponent(v)}`); });
  const finalUrl = decodeURIComponent(target) + (extra.length ? (decodeURIComponent(target).includes("?") ? "&" : "?") + extra.join("&") : "");

  // Отправка hit и цели в Метрику
  try {
    ym(105090249, 'hit', location.href);
    ym(105090249, 'reachGoal', 'redirect', Object.fromEntries(params.entries()));
    console.log("✅ Yandex.Metrika hit & goal sent");
  } catch(e){ console.warn("ym error", e); }

  // Редирект через 250ms
  setTimeout(()=> location.replace(finalUrl), 250);
});
</script>
</body>
</html>
